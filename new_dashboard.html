<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semiconductor Cost Variance Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f6fa; overflow: hidden; }
        .tab-content { display: none; height: calc(100vh - 50px); }
        .tab-content.active { display: block; }
        .process-box { transition: all 0.3s; cursor: pointer; }
        .process-box:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        #bottom-analysis-panel {
            background: white; border-top: 1px solid #e5e7eb;
            transition: all 0.3s ease-in-out;
        }
        #bottom-analysis-panel.hidden { display: none; }
        #mynetwork { width: 100%; height: 100%; }
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Global Navigation -->
    <nav class="h-[50px] bg-gradient-to-r from-indigo-600 to-purple-700 text-white flex items-center px-6 shadow-md">
        <h1 class="font-bold text-lg mr-8">üè≠ SemiCost <span class="opacity-80 text-sm font-normal">Variance Analytics</span></h1>
        <div class="flex space-x-1">
            <button class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:bg-white/10 transition" onclick="switchTab(1)" id="btn-tab-1">
                üìä Dashboard
            </button>
            <button class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:bg-white/10 transition" onclick="switchTab(2)" id="btn-tab-2">
                üî• Process Monitoring
            </button>
            <button class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:bg-white/10 transition" onclick="switchTab(3)" id="btn-tab-3">
                üï∏Ô∏è Graph Explorer
            </button>
        </div>
    </nav>

    <!-- Tab 1: Original Dashboard -->
    <div id="tab-1" class="tab-content active">
        <iframe src="/dashboard.html" class="w-full h-full border-none"></iframe>
    </div>

    <!-- Tab 2: Process Monitoring -->
    <div id="tab-2" class="tab-content p-8 overflow-auto">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Process Status Heatmap</h2>

            <!-- Process Flow Diagram -->
            <div class="flex justify-between items-center relative mb-12">
                <!-- Connecting Line -->
                <div class="absolute top-1/2 left-0 w-full h-2 bg-gray-200 -z-10 transform -translate-y-1/2 rounded"></div>

                <!-- Process Steps (Dynamic) -->
                <div id="process-flow" class="w-full flex justify-between">
                    <!-- Loading placeholder -->
                    <div class="w-full text-center text-gray-500">Loading process data...</div>
                </div>
            </div>

            <!-- Recent Alerts -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">üö® Recent High Variance Alerts</h3>
                <div id="alerts-list" class="space-y-3">
                    <!-- List items will be injected here -->
                </div>
            </div>

            <!-- Bottom Analysis Panel (Moved from Drawer) -->
            <div id="bottom-analysis-panel" class="bg-white rounded-lg shadow p-6 hidden">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="font-bold text-xl text-gray-800" id="analysis-title">Analysis</h3>
                    <button onclick="closeAnalysisPanel()" class="text-gray-500 hover:text-red-500 text-xl">&times;</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Left Column: Waterfall & Details -->
                    <div>
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-2">üí∞ Cost Breakdown (Waterfall)</h4>
                            <div class="mb-2">
                                <select id="orderSelect" class="w-full border p-2 rounded text-sm bg-white" onchange="if(this.value) openOrderDrilldown(this.value)">
                                    <option value="">-- Select Production Order --</option>
                                </select>
                            </div>
                            <div id="waterfall-chart" class="w-full h-80 bg-gray-50 rounded flex items-center justify-center border">
                                <span class="text-gray-400">Select an order to view costs</span>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">üìã Details</h4>
                            <div id="analysis-details" class="text-sm text-gray-600 max-h-40 overflow-y-auto border p-2 rounded"></div>
                        </div>
                    </div>

                    <!-- Right Column: Graph & Cost Allocation -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-gray-700">üï∏Ô∏è Root Cause / Cost Allocation Graph</h4>
                            <div class="space-x-2">
                                <button id="btn-view-allocation" onclick="viewCostAllocation()" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded hover:bg-purple-200 hidden">View Allocation</button>
                                <button onclick="openInExplorer()" class="text-xs text-indigo-600 hover:underline">Full Screen ‚Üó</button>
                            </div>
                        </div>
                        <div id="mini-network" class="w-full h-[500px] bg-gray-50 rounded border"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 3: Graph Explorer -->
    <div id="tab-3" class="tab-content relative">
        <div id="mynetwork" class="bg-gray-50"></div>

        <!-- Graph Controls -->
        <div class="absolute top-4 left-4 bg-white p-4 rounded shadow-md w-80">
            <h3 class="font-bold text-gray-700 mb-2">Explorer Controls</h3>
            <div class="flex gap-2 mb-2">
                <input type="text" id="graph-search-input" placeholder="Search Order/Variance ID..." class="flex-1 border p-1 rounded text-sm">
                <button onclick="searchGraphNode()" class="bg-indigo-600 text-white px-3 rounded text-sm">Go</button>
            </div>
            <div class="text-xs text-gray-500">
                Double-click a node to expand.<br>
                Drag to rearrange.
            </div>
            <div id="graph-status" class="mt-2 text-xs font-semibold text-indigo-600"></div>
        </div>
    </div>


    <script>
        // --- State ---
        let currentTab = 1;
        let networkInstance = null;
        let miniNetworkInstance = null;
        let currentFocusId = null;

        // --- Navigation ---
        function switchTab(tabId) {
            currentTab = tabId;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');

            // Update buttons
            for(let i=1; i<=3; i++) {
                const btn = document.getElementById(`btn-tab-${i}`);
                if (i === tabId) {
                    btn.classList.add('border-white');
                    btn.classList.remove('border-transparent');
                } else {
                    btn.classList.remove('border-white');
                    btn.classList.add('border-transparent');
                }
            }

            if (tabId === 2) loadProcessHeatmap();
            if (tabId === 3 && currentFocusId) loadGraph(currentFocusId, 'mynetwork');
        }

        function closeAnalysisPanel() {
            document.getElementById('bottom-analysis-panel').classList.add('hidden');
        }

        function openInExplorer() {
            if (currentFocusId) {
                switchTab(3);
                loadGraph(currentFocusId, 'mynetwork');
            }
        }

        // --- Tab 2: Process Monitoring (SK Hynix V2) ---
        async function loadProcessHeatmap() {
            const container = document.getElementById('process-flow');
            container.innerHTML = '<div class="spinner"></div>';

            loadAlerts(); // Load alerts concurrently

            try {
                // Use new SK Hynix endpoint
                const res = await fetch('/api/skhynix/process-status');
                if(!res.ok) throw new Error("Failed to fetch process status");
                const data = await res.json();

                if (!data || data.length === 0) {
                     container.innerHTML = '<div class="w-full text-center text-gray-500 py-8">No process data available.</div>';
                     return;
                }

                let html = '';
                // The data is a list of processes with risk levels
                // We display them in a flow if possible, or grid
                // Assuming simple grid for now as order isn't guaranteed in response (unless sorted)

                // Sort by ID to approximate process order (VF-PHOTO -> ... -> VF-TEST)
                // Or map specific IDs if order is critical.

                data.forEach(p => {
                    let colorClass = 'bg-green-100 border-green-500 text-green-800';
                    let icon = '‚úÖ';

                    if (p.risk_level >= 20) {
                        colorClass = 'bg-red-100 border-red-500 text-red-800';
                        icon = 'üî•';
                    } else if (p.risk_level > 0) {
                        colorClass = 'bg-yellow-100 border-yellow-500 text-yellow-800';
                        icon = '‚ö†Ô∏è';
                    }

                    // On click: Open Drilldown for this VF Area (latest state)
                    const stateId = p.state_id; // e.g., STATE-VF-PHOTO-2025-06
                    const clickAction = stateId ? `onclick="openProcessDrilldown('${p.id}', '${p.name}', '${stateId}')"` : '';

                    html += `
                        <div class="process-box w-48 p-4 rounded-lg border-l-4 ${colorClass} bg-white shadow-sm relative z-10 m-2" ${clickAction}>
                            <div class="text-xs font-bold uppercase tracking-wider mb-1 opacity-70">${p.type}</div>
                            <div class="font-bold text-lg mb-2 text-sm">${p.name}</div>
                            <div class="flex justify-between items-center">
                                <span class="text-2xl">${icon}</span>
                                <div class="text-right">
                                    <div class="text-xs">Month</div>
                                    <div class="font-bold text-sm">${p.month || '-'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // Wrap in flex/grid
                container.innerHTML = `<div class="flex flex-wrap justify-center">${html}</div>`;

            } catch (e) {
                console.error(e);
                container.innerHTML = `<div class="text-red-500 text-center">Error loading heatmap: ${e.message}</div>`;
            }
        }

        async function loadAlerts() {
            const container = document.getElementById('alerts-list');

            try {
                const res = await fetch('/api/skhynix/alerts');
                const data = await res.json();

                if(!data || data.length === 0) {
                    container.innerHTML = '<div class="text-gray-400 text-sm p-4 text-center">No recent alerts found.</div>';
                    return;
                }

                container.innerHTML = data.map(item => `
                    <div class="flex justify-between items-center p-3 hover:bg-gray-50 rounded border-b cursor-pointer" onclick="openOrderDrilldown('${item.state_id}')">
                        <div>
                            <div class="font-bold text-indigo-600">${item.process_name}</div>
                            <div class="text-xs text-gray-500">${item.month} | ${item.symptom}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-red-500">${formatMoney(item.cost)}</div>
                        </div>
                    </div>
                `).join('');
            } catch(e) {
                console.error("Alerts error:", e);
                container.innerHTML = '<div class="text-gray-400 text-sm p-4">Failed to load alerts</div>';
            }
        }

        // --- Drill-down Panel ---
        async function openProcessDrilldown(vfId, vfLabel, stateId) {
            document.getElementById('analysis-title').textContent = `Analysis: ${vfLabel} (${stateId})`;
            const panel = document.getElementById('bottom-analysis-panel');
            panel.classList.remove('hidden');
            panel.scrollIntoView({ behavior: 'smooth' });

            document.getElementById('btn-view-allocation').classList.add('hidden'); // Not used for now in this flow

            // Load Waterfall for the State
            currentFocusId = stateId;
            loadWaterfall(stateId);

            // Load Graph for the State
            loadGraph(stateId, 'mini-network');

            document.getElementById('analysis-details').innerHTML = `Analyzing <b>${vfLabel}</b> for the month of <b>${stateId.split('-').slice(-2).join('-')}</b>.`;
        }

        async function openOrderDrilldown(id) {
            // "id" here is likely a MonthlyVFState ID or ProductionOrder ID
            document.getElementById('analysis-title').textContent = `Drilldown: ${id}`;
            const panel = document.getElementById('bottom-analysis-panel');
            panel.classList.remove('hidden');

            currentFocusId = id;

            loadWaterfall(id);
            loadGraph(id, 'mini-network');
        }

        async function loadWaterfall(nodeId) {
            const container = document.getElementById('waterfall-chart');
            container.innerHTML = '<div class="spinner"></div>';

            try {
                // If ID starts with STATE-, it's skhynix v2
                let url = '';
                let isV2 = false;
                if(nodeId.startsWith('STATE-')) {
                    url = `/api/skhynix/waterfall/${nodeId}`;
                    isV2 = true;
                } else {
                    url = `/api/order-costs/${nodeId}`;
                }

                const res = await fetch(url);
                if(!res.ok) throw new Error("Failed to load costs");
                const data = await res.json();

                let plotData = [];

                if (isV2) {
                    // { total: ..., breakdown: [{label, value}] }
                    const x = [];
                    const y = [];
                    const measure = [];
                    const text = [];

                    // Start from 0
                    x.push("Baseline");
                    y.push(0);
                    measure.push("absolute");
                    text.push("0");

                    data.breakdown.forEach(item => {
                        x.push(item.label);
                        y.push(item.value);
                        measure.push("relative");
                        text.push("+" + formatMoney(item.value));
                    });

                    x.push("Total Cost");
                    y.push(data.total);
                    measure.push("total");
                    text.push(formatMoney(data.total));

                    plotData = [{
                        type: "waterfall",
                        orientation: "v",
                        measure: measure,
                        x: x,
                        textposition: "outside",
                        text: text,
                        y: y,
                        connector: { line: { color: "rgb(63, 63, 63)" } },
                        decreasing: { marker: { color: "#2ecc71" } },
                        increasing: { marker: { color: "#e74c3c" } },
                        totals: { marker: { color: "#3498db" } }
                    }];

                } else {
                    // Legacy format
                     // Prepare Plotly data
                    const x = [];
                    const y = [];
                    const measure = [];
                    const text = [];

                    // Base
                    x.push("Planned Cost");
                    y.push(data.total_planned);
                    measure.push("absolute");
                    text.push(formatMoney(data.total_planned));

                    // Variances
                    data.variances.forEach(v => {
                        x.push(v.element);
                        y.push(v.amount);
                        measure.push("relative");
                        text.push((v.amount > 0 ? "+" : "") + formatMoney(v.amount));
                    });

                    // Final
                    x.push("Actual Cost");
                    y.push(data.total_actual);
                    measure.push("total");
                    text.push(formatMoney(data.total_actual));

                    plotData = [{
                        type: "waterfall",
                        orientation: "v",
                        measure: measure,
                        x: x,
                        textposition: "outside",
                        text: text,
                        y: y,
                        connector: { line: { color: "rgb(63, 63, 63)" } },
                        decreasing: { marker: { color: "#2ecc71" } },
                        increasing: { marker: { color: "#e74c3c" } },
                        totals: { marker: { color: "#3498db" } }
                    }];
                }

                const layout = {
                    title: { text: "Cost Breakdown" },
                    waterfallgap: 0.3,
                    margin: { t: 50, b: 50, l: 50, r: 50 },
                    height: 250
                };

                container.innerHTML = '';
                Plotly.newPlot('waterfall-chart', plotData, layout, {displayModeBar: false});

            } catch(e) {
                container.innerHTML = `<div class="text-red-500 text-sm p-4">${e.message}</div>`;
            }
        }

        // --- Tab 3: Graph Explorer ---
        async function loadGraph(rootId, containerId) {
            const container = document.getElementById(containerId);
            const statusEl = document.getElementById('graph-status');
            if(statusEl) statusEl.textContent = `Loading ${rootId}...`;

            try {
                // Determine endpoint based on ID pattern
                let type = 'production-order';
                if(rootId.startsWith('WC')) type = 'workcenter';
                else if(rootId.startsWith('MAT')) type = 'material';
                else if(rootId.startsWith('VAR')) type = 'variance';
                else if(rootId.startsWith('PKG')) type = 'product';
                else if(rootId.startsWith('VF-')) type = 'node'; // Generic expand
                else if(rootId.startsWith('STATE-')) type = 'node'; // Generic expand
                else if(rootId.startsWith('EVT-')) type = 'node'; // Generic expand

                let endpoint = `/api/${type}/${rootId}/graph`;
                if (type === 'variance') endpoint = `/api/variance/${rootId}/graph`;
                if (type === 'node') endpoint = `/api/node/${rootId}/expand`;

                const res = await fetch(endpoint);
                if(!res.ok) throw new Error("API Error: " + res.statusText);
                const data = await res.json();

                if(data.error) throw new Error(data.error);
                if(!data.nodes || !Array.isArray(data.nodes)) {
                     // Sometimes expand returns empty if node not found
                     if (type === 'node' && data.nodes.length === 0) throw new Error("Node not found or no connections");
                     else throw new Error("Invalid graph data format");
                }

                const nodes = new vis.DataSet(data.nodes);
                const edges = new vis.DataSet(data.edges || []);

                const options = {
                    nodes: { shape: 'dot', font: { size: 12 } },
                    edges: { arrows: 'to', smooth: { type: 'cubicBezier' } },
                    physics: {
                        stabilization: true,
                        barnesHut: { gravitationalConstant: -3000, springLength: 200 }
                    }
                };

                const network = new vis.Network(container, { nodes, edges }, options);

                network.on("doubleClick", async function (params) {
                    if (params.nodes.length === 1) {
                        const nodeId = params.nodes[0];
                        await expandNode(nodeId, nodes, edges);
                    }
                });

                if(containerId === 'mynetwork') networkInstance = network;
                else miniNetworkInstance = network;

                if(statusEl) statusEl.textContent = `Loaded ${nodes.length} nodes.`;

            } catch(e) {
                console.error(e);
                if(statusEl) statusEl.textContent = "Error loading graph.";
            }
        }

        async function expandNode(nodeId, nodes, edges) {
            try {
                const res = await fetch(`/api/node/${nodeId}/expand`);
                const data = await res.json();

                data.nodes.forEach(n => {
                    if(!nodes.get(n.id)) nodes.add(n);
                });
                data.edges.forEach(e => {
                    if(!edges.get(e.id)) edges.add(e);
                });
            } catch(e) {
                console.error("Expand failed", e);
            }
        }

        function searchGraphNode() {
            const id = document.getElementById('graph-search-input').value;
            if(id) {
                currentFocusId = id;
                loadGraph(id, 'mynetwork');
            }
        }

        function loadOrderSelect() {
            // Deprecated/Hidden for now in V2 or needs update
            // Keeping empty to avoid errors
        }

        // --- Utils ---
        function formatMoney(amount) {
            return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(amount);
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
             // Default init
        });

    </script>
</body>
</html>
